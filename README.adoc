image:https://github.com/tillkuhn/billy-idle/actions/workflows/go.yml/badge.svg[ci-build]

== üí§ Billy Idle - Lightweight macOS (In)activity Tracker

Simple busy / idle time tracker inspired by the ancient article https://www.dssw.co.uk/blog/2015-01-21-inactivity-and-idle-time/[Inactivity and Idle Time on OS X].


== Background

According to the article, OS X has a timer called *HIDIdleTime* that tracks the last time you interacted with the computer, e.g. moved the mouse, typed a key, or interacted with the computer.

*billy-idle* simply queries this value periodically using the `ioreg` utility that ships with macOS, and matches it against a pre-defined threshold. If exceeded, it will create a record for the busy time period in database. This data can later be used as input for time tracking tools or statistics.

== Example Report

----
------------------------------------ DAILY BILLY IDLE REPORT ------------------------------
Tuesday 13:10:03: Spent 2m30s Drinking a Bock Celebrator Doppelbock
Tuesday 13:54:12: Spent 40m52s Building app Horsehad in Cayenne
Tuesday 14:07:48: Spent 2s Driving a Highlander Hybrid 2wd Passenger car compact to Austin
Tuesday 14:10:23: Spent 1s Drinking a Bock HopSlam Ale
Tuesday 14:10:35: Spent 2s Driving a Sl600 Passenger car light to Winston-Salem
Tuesday 14:11:21: Spent 5s Drinking a Porter Racer 5 India Pale Ale, Bear Republic Bre
Tuesday 14:11:32: Spent 3s Drinking a Belgian And French Ale Pliny The Elder
Tuesday 14:12:48: Spent 1s Drinking a Dark Lager Founders Breakfast Stout
Tuesday 14:35:04: Spent 1m6s Building app Thingdoes in SASL
Tuesday 14:36:10: Spent 23s Drinking a Porter Orval Trappist Ale
Tuesday 14:36:33: Spent 1h51m16s Eating a Viskos praline sauce with Blueberry
Tuesday 16:28:49: Spent 44m40s Driving a Charger Sport utility vehicle to St. Petersburg
------------------------------------------------------------------------------------
Total time spent: 3h21m0s (net) / 3h51m0s (with 30m0s kitKat break)
------------------------------------------------------------------------------------
----

== Run form source

[source,shell]
----
$ go run main.go

2024/10/01 17:13:29 üé¨ billy started version=v0.0.2 built=2024-10-01T15:13:28Z pid=37477 go=go1.23.1 arch=arm64
2024/10/01 17:13:29 ü•´ Open database file=~/.billy-idle/default/db.sqlite3 sqlite=3.46.0
2024/10/01 17:13:29 üëÄ Tracker started in idle mode with auto-idle>=2m0s interval=10s
2024/10/01 17:13:29 üêù Enter busy mode after 0s idle time rec=#13
2024/10/01 17:15:33 üí§ Checkpoint idleTime=11s state=idle lastSwitch=0s ago lastCheck=5s ago
2024/10/01 17:15:38 üõë Received signal interrupt, initiate shutdown
2024/10/01 17:15:38 üõë Tracker stopped after 0s busy time rec=#10
2024/10/01 17:15:38 ü•´ Close database in ~/.billy-idle/dev
----

NOTE: Binary packages for macOS amd64 and arm64 are coming soon, the same goes for docker images on ghcr.io

== Install as launchd managed service (experimental)

Plist files in ~/Library/LaunchAgents/ are run at login with the id of the logged in user.
See https://stackoverflow.com/a/13372744/4292075[SO: launchctl and .plist file],
https://ieftimov.com/posts/create-manage-macos-launchd-agents-golang/[Create and manage MacOS LaunchAgents using Go]
and  https://developer.apple.com/library/archive/documentation/MacOSX/Conceptual/BPSystemStartup/Chapters/CreatingLaunchdJobs.html#//apple_ref/doc/uid/10000172i-SW7-BCIEDDBJ[Launching Custom Daemons Using launchd]

[source,shell]
----
$ cp com.github.tillkuhn.billy-idle.plist ~/Library/LaunchAgents
$ launchctl load ~/Library/LaunchAgents/com.github.tillkuhn.billy-idle.plist
$ launchctl start com.github.tillkuhn.billy-idle

# in case of Load failed: 5: Input/output error, try this first
$ launchctl unload ~/Library/LaunchAgents/com.github.tillkuhn.billy-idle.plist
----

== CLI Arguments

[source,shell]
----
$ billy track -help

  -app-dir string
    	App Directory e.g. for SQLite DB (defaults to $HOME/.billy-idle/<env>
  -cmd string
    	Command to retrieve HIDIdleTime (default "ioreg")
  -debug
    	Debug checkpoints
  -drop-create
    	Drop and re-create db schema on startup
  -env string
    	Environment (default "default")
  -idle duration
    	Max tolerated idle time before client enters idle state (default 10s)
  -interval duration
    	Interval to check for idle time (default 2s)
----

== Database Support

*Billy Idle* currently only support a local https://gitlab.com/cznic/sqlite[sqlite] database, more precisely `modernc.org/sqlite` which is a cgo-free port of SQLite. But it shouldn't be a big deal to add support for a remote https://www.postgresql.org[PostgreSQL] Database.

image:docs/sqlite.png[]

== Development

[source,shell]
----
$ make
Usage: make <OPTIONS> ... <TARGETS>

Available targets are:

build                build all targets
build-mac            build for mac current arch using default goreleaser target path
clean                Clean output directory
help                 Shows the help
install              Install as launchd managed service
lint                 Lint go code
logs                 Show agent logs
minor                Create Minor Release
release              run goreleaser in snapshot mode
report               Show report for default db
report-dev           Show report for dev db
run                  Run app in tracker mode, add -drop-create to recreate db
run-help             Run app in help mode
run-mac              run mac build
test                 Run tests with coverage, implies lint
tidy                 Add missing and remove unused modules
update               Update all go dependencies
----

== üé∏ Credits

image:https://upload.wikimedia.org/wikipedia/commons/thumb/7/74/Billy_idol_ill_artlibre_jnl.png/640px-Billy_idol_ill_artlibre_jnl.png[]

Source: https://commons.wikimedia.org/wiki/File:Billy_idol_ill_artlibre_jnl.png[Wikimedia Commons], terms of the https://en.wikipedia.org/wiki/en:Free_Art_License[Free Art License] apply.

== Contribution

If you want to contribute to *rubin* please have a look at the xref:CONTRIBUTING.md[]
